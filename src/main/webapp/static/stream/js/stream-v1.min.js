/**
 * @name Uploader.js
 * @author Jiang
 * @create	2012-12-20
 * @version 0.1
 * @description	The Annouse funtion for HTML5/FLASH/FORM upload method. The
 * 	function will autoly to choose the property method to ajust to client
 *  Browswer. This js function mainly borrow from youku.com's uploader.min.js
 *  and try to re-create it for fullfiting my requirement. 
 * @example
 * 		1. new Stream();
 * 		2. var cfg = {
 * 				extFilters : [".txt", ".gz"],
 * 				fileFieldName : "FileData"
 * 			};
 * 		   new Stream(cfg);
 */(function(){function w(a){var b=(new Date).getTime()+"_01v_"+ ++Q;return a?a+"_"+b:b}function h(a,b){var c=2<arguments.length?[arguments[2]]:null;return function(){var d="string"===typeof a?b[a]:a,e=c?[arguments[0]].concat(c):arguments;return d.apply(b||d,e)}}function p(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c}function m(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):a["on"+b]=null}function x(a){var b=
{undefined:"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error"};return b[typeof a]||b[Object.prototype.toString.call(a)]||(a?"object":"null")}function y(a,b,c){var d=[],e="\x26",f=function(a,c){var e=b?/\[\]$/.test(b)?b:b+"["+c+"]":c;"undefined"!=e&&"undefined"!=c&&d.push("object"===typeof a?y(a,e,!0):"[object Function]"===Object.prototype.toString.call(a)?
encodeURIComponent(e)+"\x3d"+encodeURIComponent(a()):encodeURIComponent(e)+"\x3d"+encodeURIComponent(a))};if(!c&&b)e=/\?/.test(b)?/\?$/.test(b)?"":"\x26":"?",d.push(b),d.push(y(a));else if("[object Array]"===Object.prototype.toString.call(a)&&"undefined"!=typeof a){var g=0;for(c=a.length;g<c;++g)f(a[g],g)}else if("undefined"!=typeof a&&null!==a&&"object"===typeof a)for(g in a)f(a[g],g);else d.push(encodeURIComponent(b)+"\x3d"+encodeURIComponent(a));return d.join(e).replace(/^&/,"").replace(/%20/g,
"+")}function E(a,b){var c={},d;for(d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c}function q(a,b){RegExp("(^| )"+b+"( |$)").test(a.className)||(a.className+=" "+b)}function r(a,b){a.className=a.className.replace(RegExp("(^| )"+b+"( |$)")," ").replace(/^\s+|\s+$/g,"")}function s(a){var b=document.createElement("div");b.innerHTML=a;a=b.childNodes;return a[0].parentNode.removeChild(a[0])}function k(a,b){var c=document.getElementById(K);c&&(c.innerHTML+="\x3cbr\x3e"+(b?"\x3cspan style\x3d'color:red;'\x3e"+
a+"\x3c/span\x3e":a))&&(c.scrollTop=c.scrollHeight)}function F(a){return"number"===typeof a&&isFinite(a)}function A(a,b){return window.getComputedStyle?window.getComputedStyle(a,null)[b]:a.currentStyle[b]}function L(a){if(null==a)return 0;var b=a.offsetWidth,c=["Left","Right"];if(0===b||null==b)return 0;for(var d=0,e;e=c[d++];)b-=parseFloat(A(a,"border"+e+"Width"))||0,b-=parseFloat(A(a,"padding"+e))||0;return b+"px"}function M(a){if(null==a)return 0;var b=a.offsetHeight,c=["Top","Bottom"];if(0===
b||null==b)return 0;for(var d=0,e;e=c[d++];)b-=parseFloat(A(a,"border"+e+"Width"))||0,b-=parseFloat(A(a,"padding"+e))||0;return b+"px"}function G(a,b,c,d){var e,f,g;if(!a||!b)return a||{};if(d)for(e=0,g=d.length;e<g;++e)f=d[e],!Object.prototype.hasOwnProperty.call(b,f)||!c&&f in a||(a[f]=b[f]);else{for(f in b)!Object.prototype.hasOwnProperty.call(b,f)||!c&&f in a||(a[f]=b[f]);({valueOf:0}).propertyIsEnumerable("valueOf")||G(a,b,c,"hasOwnProperty isPrototypeOf propertyIsEnumerable toString toLocaleString valueOf".split(" "))}return a}
function N(){G(this.constructor.prototype,{publish:function(a){this._evts[a]||(this._evts[a]=null)},on:function(a,b,c){var d=this._evts;d[a]={};d[a].type=a;this.name&&(d[a].type=this.name+":"+a);d[a].fn=function(){b.apply(c,arguments)}},after:function(a,b,c){this.on(a,b,c)},fire:function(a){var b=this._evts[a];if(b){var c={target:this,type:b.type},d=Array.prototype.slice.call(arguments,1),e=d[0],f=typeof e;if(!e||"object"!==f&&"function"!==f&&"function"!==x(e))d[0]=c;else for(var g in c)d[0][g]?d[0]["_"+
g]=c[g]:d[0][g]=c[g];"function"===x(b.fn)&&b.fn.apply(this,d)}},detach:function(a){delete this._evts[a]}},!1);this._evts={}}function u(a){N.call(this);this._isApplySuperClass||G(this.constructor.prototype,u.prototype,!1);if(a)for(var b in a)this.set(b,a[b]);"function"===typeof this.initializer&&this.initializer.apply(this,arguments)}function l(a,b,c){N.call(this);var d=this._id=w("uploader-swf");c=c||{};var e=((c.version||R)+"").split("."),e=l.isFlashVersionAtLeast(parseInt(e[0],10),parseInt(e[1],
10),parseInt(e[2],10)),f=l.isFlashVersionAtLeast(8,0,0)&&!e&&c.useExpressInstall,g=f?S:b;b="\x3cobject ";var z="\x26SWFId\x3d"+d+"\x26callback\x3d"+T+"\x26allowedDomain\x3d"+document.location.hostname;l._instances[d]=this;if(a&&(e||f)&&g){b+='id\x3d"'+d+'" ';b=t.ie?b+('classid\x3d"'+U+'" '):b+('type\x3d"'+V+'" data\x3d"'+g+'" ');b+='width\x3d"100%" height\x3d"100%"\x3e';t.ie&&(b+='\x3cparam name\x3d"movie" value\x3d"'+g+'"/\x3e');for(var k in c.fixedAttributes)W.hasOwnProperty(k)&&(b+='\x3cparam name\x3d"'+
k+'" value\x3d"'+c.fixedAttributes[k]+'"/\x3e');for(var h in c.flashVars)k=c.flashVars[h],"string"===typeof k&&(z+="\x26"+h+"\x3d"+encodeURIComponent(k));z&&(b+='\x3cparam name\x3d"flashVars" value\x3d"'+z+'"/\x3e');a.innerHTML=b+"\x3c/object\x3e";this.swf=document.getElementById(d)}else this.publish("wrongflashversion",{fireOnce:!0}),this.fire("wrongflashversion",{type:"wrongflashversion"})}function H(a){this.swfContainerId=w("uploader");this.queue=this.swfReference=null;this.buttonState="up";this.config=
{enabled:!0,multipleFiles:!0,buttonClassNames:{hover:"uploader-button-hover",active:"uploader-button-active",disabled:"uploader-button-disabled",focus:"uploader-button-selected"},containerClassNames:{hover:"uphotBg"},fileFilters:a.fileFilters,fileFieldName:"FileData",simLimit:1,retryCount:3,postVarsPerFile:{},swfURL:"/swf/FlashUploader.swf",uploadURL:"/fd"};u.apply(this,arguments)}function B(a){this.bytesSpeed=this.bytesPrevLoaded=0;this.bytesSpeeds=[];this.preTime=this.remainTime=0;this.config={id:"",
name:"",size:"",type:"",dateCreated:"",dateModified:"",uploader:""};u.apply(this,arguments)}function I(a){this.buttonBinding=this.queue=this.fileInputField=null;this.config={enabled:!0,multipleFiles:!0,dragAndDropArea:"",dragAndDropTips:"",fileFilters:a.fileFilters,fileFieldName:"FileData",simLimit:1,retryCount:3,postVarsPerFile:{},uploadURL:"/upload"};u.apply(this,arguments)}function C(a){a=a||{};this.bStreaming=v;this.bDraggable=D;this.uploadInfo={};this.config={enabled:!0,customered:!!a.customered,
multipleFiles:!!a.multipleFiles,autoRemoveCompleted:!!a.autoRemoveCompleted,autoUploading:null==a.autoUploading?!0:!!a.autoUploading,dragAndDropArea:a.dragAndDropArea,dragAndDropTips:a.dragAndDropTips||"\x3cspan\x3e\u628a\u6587\u4ef6(\u6587\u4ef6\u5939)\u62d6\u62fd\u5230\u8fd9\u91cc\x3c/span\x3e",fileFieldName:a.fileFieldName||"FileData",browser:a.browser,browseFileId:a.browseFileId||"i_select_files",browseFileBtn:a.browseFileBtn||"\x3cdiv\x3e\u8bf7\u9009\u62e9\u6587\u4ef6\x3c/div\x3e",filesQueueId:a.filesQueueId||
"i_stream_files_queue",filesQueueHeight:a.filesQueueHeight||450,messagerId:a.messagerId||"i_stream_message_container",onSelect:a.onSelect,onAddTask:a.onAddTask,onMaxSizeExceed:a.onMaxSizeExceed,onFileCountExceed:a.onFileCountExceed,onExtNameMismatch:a.onExtNameMismatch,onCancel:a.onCancel,onStop:a.onStop,onCancelAll:a.onCancelAll,onComplete:a.onComplete,onQueueComplete:a.onQueueComplete,onUploadProgress:a.onUploadProgress,onUploadError:a.onUploadError,onDestroy:a.onDestroy,maxSize:a.maxSize||2147483648,
simLimit:a.simLimit||1E4,fileFilters:"array"===x(a.extFilters)?a.extFilters:[],retryCount:a.retryCount||5,postVarsPerFile:a.postVarsPerFile||{},swfURL:a.swfURL||"/swf/FlashUploader.swf",tokenURL:a.tokenURL||"initImportFile.do",frmUploadURL:a.frmUploadURL||t.firefox?"/fd;"+document.cookie:"/fd",uploadURL:a.uploadURL||"importFile.do"};u.apply(this,arguments)}var O,Q=0,P=["Maxthon","SE 2.X","QQBrowser"];Array.isArray&&/\{\s*\[(?:native code|function)\]\s*\}/i.test(Array.isArray);var K="i_stream_message_container";
u.prototype={_isApplySuperClass:!0,initializer:function(){},get:function(a){return this.config[a]},set:function(a,b){var c;a&&"undefined"!==typeof b&&a in this.config&&(this.config[a]=b,c=a+"Change",this._evt&&c in this._evt.events&&this.fire(c))}};l.getFlashVersion=function(){return""+t.flashMajor+"."+(""+t.flashMinor)+"."+(""+t.flashRev)};l.isFlashVersionAtLeast=function(a,b,c){return!0};l._instances=l._instances||{};l.eventHandler=function(a,b){l._instances[a]._eventHandler(b)};l.prototype={initializer:function(){},
_eventHandler:function(a){"swfReady"===a.type?(this.publish("swfReady",{fireOnce:!0}),this.fire("swfReady",a)):"log"!==a.type&&this.fire(a.type,a)},callSWF:function(a,b){b||(b=[]);return this.swf[a]?this.swf[a].apply(this.swf,b):null},toString:function(){return"SWF "+this._id}};l.prototype.constructor=l;H.prototype={constructor:H,name:"uploader",buttonState:"up",swfContainerId:null,swfReference:null,queue:null,initializer:function(){this.publish("fileselect");this.publish("uploadstart");this.publish("fileuploadstart");
this.publish("uploadprogress");this.publish("totaluploadprogress");this.publish("uploadcomplete");this.publish("alluploadscomplete");this.publish("uploaderror");this.publish("mouseenter");this.publish("mouseleave");this.publish("mousedown");this.publish("mouseup");this.publish("click")},render:function(a){a&&(this.renderUI(a),this.bindUI())},renderUI:function(a){this.contentBox=a;this.contentBox.style.position="relative";a=a.getBoundingClientRect();a=s("\x3cdiv id\x3d'"+this.swfContainerId+"' style\x3d'opacity:0;top:"+
a.top+"px; left:"+a.left+"px; margin: 0; padding: 0;position:absolute; border: 0; width:"+a.width+"px; height:"+a.height+"px'\x3e\x3c/div\x3e");document.body.appendChild(a);this.swfReference=new l(a,this.get("swfURL"),{version:"10.0.45",fixedAttributes:{wmode:"transparent",allowScriptAccess:"always",allowNetworking:"all",scale:"noscale"}});this.fileInputField=a},bindUI:function(){this.bindSelectButton();this.setMultipleFiles();this.setFileFilters();this.triggerEnabled();this.swfReference.on("swfReady",
function(){this.setMultipleFiles();this.setFileFilters();this.triggerEnabled();this.after("multipleFilesChange",this.setMultipleFiles,this);this.after("fileFiltersChange",this.setFileFilters,this);this.after("enabledChange",this.triggerEnabled,this)},this);this.swfReference.on("fileselect",this.updateFileList,this);this.swfReference.on("mouseenter",function(){this.setContainerClass("hover",!0)},this);this.swfReference.on("mouseleave",function(){this.setContainerClass("hover",!1)},this)},destroy:function(){this.swfReference.detach("fileselect",
this.updateFileList,this);this.swfReference.detach("mouseenter",function(){this.setContainerClass("hover",!0)},this);this.swfReference.detach("mouseleave",function(){this.setContainerClass("hover",!1)},this);if(this.contentBox)for(;this.contentBox.firstChild;)this.contentBox.removeChild(this.contentBox.firstChild);this.fileInputField&&(this.fileInputField=this.fileInputField.parentNode.removeChild(this.fileInputField),this.fileInputField.removeNode());this.swfReference=null},setContainerClass:function(a,
b){b?q(this.contentBox,this.get("containerClassNames")[a]):r(this.contentBox,this.get("containerClassNames")[a])},setFileFilters:function(){this.swfReference&&0<this.get("fileFilters").length&&this.swfReference.callSWF("setFileFilters",[[{description:"\u81ea\u5b9a\u4e49\u6587\u4ef6",extensions:"*"+this.get("fileFilters").join(";*"),macType:"*"+this.get("fileFilters").join(";*")}]])},setMultipleFiles:function(){this.swfReference&&this.swfReference.callSWF("setAllowMultipleFiles",[this.get("multipleFiles")])},
triggerEnabled:function(){this.get("enabled")?(this.swfReference.callSWF("enable"),this.swfReference.swf.setAttribute("aria-disabled","false")):(this.swfReference.callSWF("disable"),this.swfReference.swf.setAttribute("aria-disabled","true"))},bindSelectButton:function(){this.buttonBinding=h(this.openFileSelectDialog,this);p(this.contentBox,"click",this.buttonBinding)},openFileSelectDialog:function(a){this.fileInputField&&this.fileInputField.firstChild&&this.fileInputField.firstChild.click&&a.target!=
this.fileInputField.firstChild&&this.fileInputField.firstChild.click()},updateFileList:function(a){this.swfReference.swf.focus();a=a.fileList;for(var b=[],c=this.swfReference,d=0;d<a.length;d++){var e={};e.id=a[d].fileId;e.name=a[d].fileReference.name;e.size=a[d].fileReference.size;e.type=a[d].fileReference.type;e.dateCreated=a[d].fileReference.creationDate;e.dateModified=a[d].fileReference.modificationDate;e.uploader=c;b.push(new B(e))}0<b.length&&this.fire("fileselect",{fileList:b})},uploadEventHandler:function(a){switch(a.type){case "executor:uploadstart":this.fire("fileuploadstart",
a);break;case "executor:uploadprogress":this.fire("uploadprogress",a);break;case "uploaderqueue:totaluploadprogress":this.fire("totaluploadprogress",a);break;case "executor:uploadcomplete":this.fire("uploadcomplete",a);break;case "uploaderqueue:alluploadscomplete":this.queue=null;this.fire("alluploadscomplete",a);break;case "executor:uploaderror":case "uploaderqueue:uploaderror":this.fire("uploaderror",a);break;case "executor:uploadcancel":case "uploaderqueue:uploadcancel":this.fire("uploadcancel",
a)}},upload:function(a,b,c){b=b||this.get("uploadURL");c=E(c,this.get("postVarsPerFile"));var d=a.id;c=c.hasOwnProperty(d)?c[d]:c;a instanceof B&&(a.on("uploadstart",this.uploadEventHandler,this),a.on("uploadprogress",this.uploadEventHandler,this),a.on("uploadcomplete",this.uploadEventHandler,this),a.on("uploaderror",this.uploadEventHandler,this),a.on("uploadcancel",this.uploadEventHandler,this),a.startUpload(b,c,this.get("fileFieldName")))}};B.prototype={constructor:B,name:"executor",initializer:function(){this.id=
w("file")},swfEventHandler:function(a){if(a.id===this.get("id"))switch(a.type){case "uploadstart":this.fire("uploadstart",{uploader:this.get("uploader")});break;case "uploadprogress":var b=(new Date).getTime(),c=(b-this.preTime)/1E3,d=0;if(1<=c||0==this.bytesPrevLoaded){this.bytesSpeed=Math.round((a.bytesLoaded-this.bytesPrevLoaded)/c);this.bytesPrevLoaded=a.bytesLoaded;this.preTime=b;5<this.bytesSpeeds.length&&this.bytesSpeeds.shift();this.bytesSpeeds.push(this.bytesSpeed);for(b=0;b<this.bytesSpeeds.length;b++)d+=
this.bytesSpeeds[b];this.bytesSpeed=Math.round(d/this.bytesSpeeds.length);this.remainTime=Math.ceil((a.bytesTotal-a.bytesLoaded)/this.bytesSpeed)}this.fire("uploadprogress",{originEvent:a,bytesLoaded:a.bytesLoaded,bytesSpeed:this.bytesSpeed,bytesTotal:a.bytesTotal,remainTime:this.remainTime,percentLoaded:Math.min(100,Math.round(1E4*a.bytesLoaded/a.bytesTotal)/100)});break;case "uploadcomplete":this.fire("uploadfinished",{originEvent:a});break;case "uploadcompletedata":this.fire("uploadcomplete",{originEvent:a,
data:a.data});break;case "uploadcancel":this.fire("uploadcancel",{originEvent:a});break;case "uploaderror":this.fire("uploaderror",{originEvent:a,status:a.status,statusText:a.message,source:a.source})}},startUpload:function(a,b,c){if(this.get("uploader")){var d=this.get("uploader");c=c||"FileData";var e=this.get("id");b=b||null;d.on("uploadstart",this.swfEventHandler,this);d.on("uploadprogress",this.swfEventHandler,this);d.on("uploadcomplete",this.swfEventHandler,this);d.on("uploadcompletedata",this.swfEventHandler,
this);d.on("uploaderror",this.swfEventHandler,this);this.remainTime=this.bytesSpeed=this.bytesPrevLoaded=0;this.bytesSpeeds=[];this.preTime||(this.preTime=(new Date).getTime());d.callSWF("upload",[e,a,b,c])}},cancelUpload:function(){this.get("uploader")&&(this.get("uploader").callSWF("cancel",[this.get("id")]),this.fire("uploadcancel"))}};I.prototype={constructor:I,name:"stream_provider",initializer:function(){this.publish("fileselect");this.publish("uploadstart");this.publish("fileuploadstart");
this.publish("uploadprogress");this.publish("totaluploadprogress");this.publish("uploadcomplete");this.publish("alluploadscomplete");this.publish("uploaderror");this.publish("dragenter");this.publish("dragover");this.publish("dragleave");this.publish("drop")},render:function(a){a&&(this.renderUI(a),this.bindUI())},renderUI:function(a){this.contentBox=a;this.fileInputField=s("\x3cinput type\x3d'file' style\x3d'visibility:hidden;width:0px;height:0px;opacity:0;position:absolute;left:-1000px;'\x3e");
this.get("dragAndDropArea")&&!this.get("dragAndDropArea").nodeType&&this.set("dragAndDropArea",document.getElementById(this.get("dragAndDropArea")));D&&this.get("dragAndDropArea")&&(q(this.get("dragAndDropArea"),"stream-browse-drag-files-area"),this.get("dragAndDropArea").appendChild(s(this.get("dragAndDropTips"))))},bindUI:function(){this.bindSelectButton();this.setMultipleFiles();this.setFileFilters();this.bindDropArea();this.triggerEnabled();this.after("multipleFilesChange",this.setMultipleFiles,
this);this.after("fileFiltersChange",this.setFileFilters,this);this.after("enabledChange",this.triggerEnabled,this);this.after("dragAndDropAreaChange",this.bindDropArea,this);p(this.fileInputField,"change",h(this.updateFileList,this))},bindDropArea:function(){var a=this.get("dragAndDropArea");this.dropBinding=h(this.dragEventHandler,this);null!==a&&(p(a,"drop",this.dropBinding),p(a,"dragenter",this.dropBinding),p(a,"dragover",this.dropBinding),p(a,"dragleave",this.dropBinding))},destroy:function(){this.buttonBinding=
h(this.openFileSelectDialog,this);m(this.contentBox,"click",this.buttonBinding);m(this.fileInputField,"change",h(this.updateFileList,this));this.detach("multipleFilesChange",this.setMultipleFiles,this);this.detach("fileFiltersChange",this.setFileFilters,this);this.detach("enabledChange",this.triggerEnabled,this);this.detach("dragAndDropAreaChange",this.bindDropArea,this);var a=this.get("dragAndDropArea");null!==a&&null!=this.dropBinding&&(m(a,"drop",this.dropBinding),m(a,"dragenter",this.dropBinding),
m(a,"dragover",this.dropBinding),m(a,"dragleave",this.dropBinding));this.dropBinding=this.buttonBinding=this.fileInputField=null},dragEventHandler:function(a){a=a||window.event;a.preventDefault?a.preventDefault():a.returnValue=!1;a.stopPropagation?a.stopPropagation():a.cancelBubble=!0;switch(a.type){case "dragenter":this.fire("dragenter");break;case "dragover":this.fire("dragover");break;case "dragleave":this.fire("dragleave");break;case "drop":var b=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(new n(a[d]));
0<c.length&&b.fire("fileselect",{fileList:c})};if(X){var c=a.dataTransfer.items;c.length&&c[c.length-1]&&(c=c[c.length-1].webkitGetAsEntry()||c[c.length-1].getAsEntry())&&this.traverseFileTree(c.filesystem.root,b)}else{c=a.dataTransfer.files;if(a.MOZ_SOURCE_MOUSE){a=[];for(var d=0;d<c.length;d++)0<c[d].size&&a.push(c[d]);c=a}b(c,this)}this.fire("drop")}},traverseFileTree:function(a,b){b.pending||(b.pending=0);b.files||(b.files=[]);b.pending++;var c=this,d=a.fullPath.replace(/^\//,"").replace(/(.+?)\/?$/,
"$1/");a.createReader().readEntries(function(e){b.pending--;if(e.length)for(var f=0;f<e.length;f++){var g=e[f];g.isFile?(b.pending++,g.file(function(a){a.RelativePath=d+a.name;b.files.push(a);0===--b.pending&&b(b.files,c)})):c.traverseFileTree(g,b)}else k("\u5ffd\u7565\u7a7a\u6587\u4ef6\u5939\uff1a`"+d+a.name+"`",!0);0===b.pending&&b(b.files,c)})},rebindFileField:function(){this.fileInputField=s("\x3cinput type\x3d'file' style\x3d'visibility:hidden;width:0px;height:0px;opacity:0;position:absolute;left:-1000px;'\x3e");
this.get("dragAndDropArea")&&!this.get("dragAndDropArea").nodeType&&this.set("dragAndDropArea",document.getElementById(this.get("dragAndDropArea")));D&&q(this.get("dragAndDropArea"),"stream-browse-drag-files-area");this.setMultipleFiles();this.setFileFilters();p(this.fileInputField,"change",h(this.updateFileList,this))},bindSelectButton:function(){this.buttonBinding=h(this.openFileSelectDialog,this);p(this.contentBox,"click",this.buttonBinding)},setMultipleFiles:function(){!0===this.get("multipleFiles")&&
this.fileInputField.setAttribute("multiple","multiple")},setFileFilters:function(){var a=this.get("fileFilters");0<a.length?this.fileInputField.setAttribute("accept",a.join(",")):this.fileInputField.setAttribute("accept","")},triggerEnabled:function(){var a=this.get("dragAndDropArea");r(a,"stream-disabled");this.get("enabled")&&null===this.buttonBinding?(this.bindSelectButton(),this.bindDropArea(),r(a,"stream-disabled")):!this.get("enabled")&&this.buttonBinding&&(m(this.contentBox,"click",this.buttonBinding),
this.buttonBinding=null,null!==a&&null!=this.dropBinding&&(m(a,"drop",this.dropBinding),m(a,"dragenter",this.dropBinding),m(a,"dragover",this.dropBinding),m(a,"dragleave",this.dropBinding),q(a,"stream-disabled")))},updateFileList:function(a){a=a.target.files;for(var b=[],c=0;c<a.length;c++)"."!=a[c].name&&b.push(new n(a[c]));0<b.length&&this.fire("fileselect",{fileList:b});this.rebindFileField()},openFileSelectDialog:function(a){this.fileInputField&&this.fileInputField.click&&a.target!=this.fileInputField&&
this.fileInputField.click()},uploadEventHandler:function(a){switch(a.type){case "executor:uploadstart":this.fire("fileuploadstart",a);break;case "executor:uploadprogress":this.fire("uploadprogress",a);break;case "uploaderqueue:totaluploadprogress":this.fire("totaluploadprogress",a);break;case "executor:uploadcomplete":this.fire("uploadcomplete",a);break;case "uploaderqueue:alluploadscomplete":this.queue=null;this.fire("alluploadscomplete",a);break;case "executor:uploaderror":case "uploaderqueue:uploaderror":this.fire("uploaderror",
a);break;case "executor:uploadcancel":case "uploaderqueue:uploadcancel":this.fire("uploadcancel",a)}},upload:function(a,b,c){b=b||this.get("uploadURL");c=E(c,this.get("postVarsPerFile"));var d=a.id;c=c.hasOwnProperty(d)?c[d]:c;a instanceof n&&(a.on("uploadstart",this.uploadEventHandler,this),a.on("uploadprogress",this.uploadEventHandler,this),a.on("uploadcomplete",this.uploadEventHandler,this),a.on("uploaderror",this.uploadEventHandler,this),a.on("uploadcancel",this.uploadEventHandler,this),a.startUpload(b,
c,this.get("fileFieldName")))}};var n=function(){this.remainTime=this.bytesSpeed=this.bytesStart=this.bytesPrevLoaded=0;this.bytesSpeeds=[];this.retryTimes=this.preTime=0;this.config={id:"",name:"",size:"",type:"",dateCreated:"",dateModified:"",uploader:"",uploadURL:"",serverAddress:"",portionSize:10485760,parameters:{},fileFieldName:"FileData",uploadMethod:"formUpload"};u.apply(this,arguments)};n.isValidFile=function(a){return"undefined"!=typeof File&&a instanceof File};n.canUpload=function(){return"undefined"!=
typeof FormData};n.prototype={constructor:n,name:"executor",initializer:function(a){this.XHR=null;this.retryTimes=10;this.retriedTimes=0;this.fileId=this.file=null;this.filePiece=10485760;this.fileSizeValue=0;this.fileStartPosValue=null;this.durationTime=2E3;this.xhrHandler=null;a=n.isValidFile(a)?a:n.isValidFile(a.file)?a.file:!1;this.get("id")||this.set("id",w("file"));a&&n.canUpload()&&(this.file||(this.file=a),this.set("name",a.RelativePath||a.webkitRelativePath||a.name||a.fileName),this.get("size")!=
(a.size||a.fileSize)&&this.set("size",a.size||a.fileSize),this.get("type")||this.set("type",a.type),a.lastModifiedDate&&!this.get("dateModified")&&this.set("dateModified",a.lastModifiedDate))},resetXhr:function(){if(this.XHR){try{this.XHR.upload.removeEventListener("progress",this.xhrHandler),this.XHR.upload.removeEventListener("error",this.xhrHandler),this.XHR.upload.removeEventListener("abort",this.xhrHandler),this.XHR.removeEventListener("loadend",this.xhrHandler),this.XHR.removeEventListener("error",
this.xhrHandler),this.XHR.removeEventListener("abort",this.xhrHandler),this.XHR.removeEventListener("readystatechange",this.xhrHandler)}catch(a){throw a;}this.XHR=null}},formUpload:function(){this.resetXhr();this.XHR=new XMLHttpRequest;this.uploadEventHandler=h(this.uploadEventHandler,this);var a=new FormData,b=this.get("fileFieldName"),c=this.get("uploadURL"),d=this.XHR,e=d.upload;this.set("uploadMethod","formUpload");this.bytesStart=0;this.preTime=(new Date).getTime();a.append(b,this.file);d.addEventListener("loadstart",
this.uploadEventHandler,!1);e.addEventListener("progress",this.uploadEventHandler,!1);d.addEventListener("load",this.uploadEventHandler,!1);d.addEventListener("error",this.uploadEventHandler,!1);e.addEventListener("error",this.uploadEventHandler,!1);e.addEventListener("abort",this.uploadEventHandler,!1);d.addEventListener("abort",this.uploadEventHandler,!1);d.addEventListener("loadend",this.uploadEventHandler,!1);d.addEventListener("readystatechange",this.uploadEventHandler,!1);d.open("POST",c,!0);
d.send(a);this.fire("uploadstart",{xhr:d})},streamUpload:function(a){var b=this.get("uploadURL");this.resetXhr();this.resume=!1;this.bytesStart=a;this.XHR=new XMLHttpRequest;this.xhrHandler=h(this.uploadEventHandler,this);var c=this.XHR,d=c.upload;c.addEventListener("loadstart",this.xhrHandler,!1);d.addEventListener("progress",this.xhrHandler,!1);c.addEventListener("load",this.xhrHandler,!1);c.addEventListener("error",this.xhrHandler,!1);d.addEventListener("error",this.xhrHandler,!1);d.addEventListener("abort",
this.xhrHandler,!1);c.addEventListener("abort",this.xhrHandler,!1);c.addEventListener("loadend",this.xhrHandler,!1);c.addEventListener("readystatechange",this.xhrHandler,!1);var d=this.sliceFile(this.file,a,a+this.filePiece),e="bytes "+a+"-"+(a+d.size)+"/"+this.get("size");this.preTime=(new Date).getTime();c.open("POST",b,!0);c.setRequestHeader("Content-Range",e);c.send(d);0===a&&this.fire("uploadstart",{xhr:c})},resumeUpload:function(){if(J){this.resetXhr();this.XHR=new XMLHttpRequest;this.resume=
!0;var a=this.get("uploadURL")+"\x26"+(new Date).getTime().toString().substring(8);this.xhrHandler=h(this.uploadEventHandler,this);this.XHR.addEventListener("loadstart",this.xhrHandler,!1);this.XHR.addEventListener("load",this.xhrHandler,!1);this.XHR.addEventListener("abort",this.xhrHandler,!1);this.XHR.addEventListener("error",this.xhrHandler,!1);this.XHR.addEventListener("loadend",this.xhrHandler,!1);this.XHR.addEventListener("readystatechange",this.xhrHandler,!1);this.preTime=(new Date).getTime();
this.XHR.open("GET",a,!0);this.XHR.send(null)}else this.formUpload()},retry:function(){this.retriedTimes++;var a=this;2>this.retriedTimes?this.resumeUpload():(this.timeoutHandler&&clearTimeout(this.timeoutHandler),this.timeoutHandler=setTimeout(function(){a.resumeUpload()},1E4))},uploadEventHandler:function(a){var b=this.XHR,c=this.get("uploadMethod");switch(a.type){case "load":var d=0,e=null,f=!1;try{if(4==b.readyState&&(200==b.status||308==b.status))d=(e=eval("("+b.responseText+")"))?e.start:-1;
else if(500>b.status&&400<=b.status)f=!0;else if(200>b.status)break;f=f||!1==e.success}catch(g){if(f="formUpload"===c||this.retriedTimes>this.retryTimes,!f){this.retry();break}}if(f){this.fire("uploaderror",{originEvent:a,status:b.status,statusText:b.responseText,source:e&&e.message});break}d<this.get("size")-1?(this.retriedTimes=0,this.streamUpload(d)):this.fire("uploadcomplete",{originEvent:a,data:a.target.responseText});break;case "error":this.retriedTimes<this.retryTimes?this.retry():this.fire("uploaderror",
{originEvent:a,status:b.status,statusText:b.statusText,source:"io"});break;case "abort":this.fire("uploadcancel",{originEvent:a});break;case "progress":b=this.get("size");c=this.bytesStart+a.loaded;e=(new Date).getTime();f=(e-this.preTime)/1E3;d=0;if(0.68<=f||0===this.bytesSpeeds.length){this.bytesPrevLoaded=Math.max(this.bytesStart,this.bytesPrevLoaded);this.bytesSpeed=Math.round((c-this.bytesPrevLoaded)/f);this.bytesPrevLoaded=c;this.preTime=e;5<this.bytesSpeeds.length&&this.bytesSpeeds.shift();
5>this.bytesSpeeds.length&&(this.bytesSpeed/=2);this.bytesSpeeds.push(this.bytesSpeed);for(e=0;e<this.bytesSpeeds.length;e++)d+=this.bytesSpeeds[e];this.bytesSpeed=Math.round(d/this.bytesSpeeds.length);this.remainTime=Math.ceil((b-c)/this.bytesSpeed)}this.fire("uploadprogress",{originEvent:a,bytesLoaded:c,bytesTotal:b,bytesSpeed:this.bytesSpeed,remainTime:this.remainTime,percentLoaded:Math.min(100,Math.floor(1E4*c/b)/100)});break;case "readystatechange":this.fire("readystatechange",{readyState:a.target.readyState,
originEvent:a})}},startUpload:function(a,b,c){this.fileStartPosValue=null;this.retriedTimes=0;b.name=this.get("name");b.size=this.get("size");var d=this.get("uploadMethod");this.set("uploadURL",y(b,a));this.set("parameters",b);this.set("fileFieldName",c);this.remainTime=this.bytesSpeed=this.bytesPrevLoaded=0;this.bytesSpeeds=[];this.resetXhr();switch(d){case "formUpload":this.formUpload();break;case "streamUpload":this.streamUpload();break;case "resumeUpload":this.resumeUpload()}},sliceFile:function(a,
b,c){b=b||0;c=c||0;return a.slice?a.slice(b,c):a.webkitSlice?a.webkitSlice(b,c):a.mozSlice?a.mozSlice(b,c):a},cancelUpload:function(){this.XHR&&(this.XHR.abort(),this.resetXhr())}};C.applyTo=function(a,b){if(!a||"SWF.eventHandler"!=a)return null;try{return l.eventHandler.apply(l,b)}catch(c){return null}};C.prototype={constructor:C,name:"uploader",initializer:function(){K=this.config.messagerId;this.startPanel=this.config.browser||document.getElementById(this.config.browseFileId);if(!this.config.customered){q(this.startPanel,
"stream-browse-files");this.startPanel.appendChild(s(this.config.browseFileBtn));var a=document.getElementById(this.config.filesQueueId);q(a,"stream-main-upload-box");var b=w("files-container"),c=w("total-container"),d=s('\x3cdiv class\x3d"stream-files-scroll" style\x3d"height: #filesQueueHeight#px;"\x3e\x3cul id\x3d"#filesContainerId#"\x3e\x3c/ul\x3e\x3c/div\x3e'.replace("#filesContainerId#",b).replace("#filesQueueHeight#",this.config.filesQueueHeight)),e=s('\x3cdiv id\x3d"#totalContainerId#" class\x3d"stream-total-tips"\x3e\t\u4e0a\u4f20\u603b\u8fdb\u5ea6\uff1a\x3cspan class\x3d"stream-process-bar"\x3e\x3cspan style\x3d"width: 0%;"\x3e\x3c/span\x3e\x3c/span\x3e\t\x3cspan class\x3d"stream-percent"\x3e0%\x3c/span\x3e\uff0c\u5df2\u4e0a\u4f20\x3cstrong class\x3d"_stream-total-uploaded"\x3e\x26nbsp;\x3c/strong\x3e\t\uff0c\u603b\u6587\u4ef6\u5927\u5c0f\x3cstrong class\x3d"_stream-total-size"\x3e\x26nbsp;\x3c/strong\x3e\x3c/div\x3e'.replace("#totalContainerId#",
c));a.appendChild(d);a.appendChild(e);this.containerPanel=document.getElementById(b);this.totalContainerPanel=document.getElementById(c);this.template='\x3cb class\x3d"stream-uploading-ico"\x3e\x3c/b\x3e\x3cdiv class\x3d"stream-file-name"\x3e\x3cstrong\x3e\x3c/strong\x3e\x3c/div\x3e\x3cdiv class\x3d"stream-process"\x3e\t\x3ca class\x3d"stream-cancel" href\x3d"javascript:void(0)"\x3e\u5220\u9664\x3c/a\x3e\t\x3cspan class\x3d"stream-process-bar"\x3e\x3cspan style\x3d"width: 0%;"\x3e\x3c/span\x3e\x3c/span\x3e\t\x3cspan class\x3d"stream-percent"\x3e0%\x3c/span\x3e\x3c/div\x3e\x3cdiv class\x3d"stream-cell-infos"\x3e\t\x3cspan class\x3d"stream-cell-info"\x3e\u901f\u5ea6\uff1a\x3cem class\x3d"stream-speed"\x3e\x3c/em\x3e\x3c/span\x3e\t\x3cspan class\x3d"stream-cell-info"\x3e\u5df2\u4e0a\u4f20\uff1a\x3cem class\x3d"stream-uploaded"\x3e\x3c/em\x3e\x3c/span\x3e\t\x3cspan class\x3d"stream-cell-info"\x3e\u5269\u4f59\u65f6\u95f4\uff1a\x3cem class\x3d"stream-remain-time"\x3e\x3c/em\x3e\x3c/span\x3e\x3c/div\x3e'}this.fileProvider=
new O(this.config);this.fileProvider.render(this.startPanel);this.fileProvider.on("uploadprogress",this.uploadProgress,this);this.fileProvider.on("uploadcomplete",this.uploadComplete,this);this.fileProvider.on("uploaderror",this.uploadError,this);this.fileProvider.on("fileselect",this.fileSelect,this);p(window,"beforeunload",h(this.unloadHandler,this));this.waiting=[];this.uploading=!1;this.totalUploadedSize=this.totalFileSize=0;this.showBrowseBlock()},addStreamTask:function(a){var b=a.get("id"),
c=s("\x3cli id\x3d'"+b+"' class\x3d'stream-cell-file'\x3e\x3c/li\x3e");c.innerHTML=this.template;this.uploadInfo[b]={uploadToken:"",uploadComplete:!1,file:a,disabled:!1,actived:!1,progressNode:this.getNode("stream-process",c),cellInfosNode:this.getNode("stream-cell-infos",c)};this.totalFileSize+=this.uploadInfo[b].file.get("size");this.config.customered||(this.getNode("stream-file-name",c).getElementsByTagName("strong")[0].innerHTML=a.get("name"),this.containerPanel.appendChild(c),this.renderUI(b),
this.bindUI(b));this.waiting.push(b);this.config.autoUploading&&this.upload(b)},hideBrowseBlock:function(){this.browseFileBlockHeight=M(this.startPanel);this.browseFileBlockWidth=L(this.startPanel);!this.browseFileBlockDisplay&&(this.browseFileBlockDisplay=""==this.startPanel.style.display?"block":this.startPanel.style.display);v?this.startPanel.style.display="none":(this.startPanel.style.height="1px",this.startPanel.style.width="1px")},showBrowseBlock:function(){!this.browseFileBlockHeight&&(this.browseFileBlockHeight=
M(this.startPanel));!this.browseFileBlockWidth&&(this.browseFileBlockWidth=L(this.startPanel));!this.browseFileBlockDisplay&&(this.browseFileBlockDisplay=""==this.startPanel.style.display?"block":this.startPanel.style.display);if("none"==this.browseFileBlockDisplay)return this.browseFileBlockDisplay="block",this.browseFileBlockHeight=this.browseFileBlockWidth=null,!1;v?this.startPanel.style.display=this.browseFileBlockDisplay:(this.startPanel.style.height=this.browseFileBlockHeight,this.startPanel.style.width=
this.browseFileBlockWidth)},renderUI:function(a){var b=this.uploadInfo[a].progressNode,c=this.uploadInfo[a].cellInfosNode;a=this.uploadInfo[a].file.get("size");a=this.formatBytes(a);this.getNode("stream-process-bar",b).innerHTML="\x3cspan style\x3d'width:0%;'\x3e\x3c/span\x3e";this.getNode("stream-percent",b).innerHTML="0%";this.getNode("stream-speed",c).innerHTML="-";this.getNode("stream-remain-time",c).innerHTML="--:--:--";this.getNode("stream-uploaded",c).innerHTML="0/"+a;b=this.formatBytes(this.totalFileSize);
this.getNode("_stream-total-size",this.totalContainerPanel).innerHTML=b},bindUI:function(a){var b=this.getNode("stream-cancel",this.uploadInfo[a].progressNode);this.cancelBtnHandler=h(this.cancelUploadHandler,this,{type:"click",nodeId:a});p(b,"click",this.cancelBtnHandler)},completeUpload:function(a){var b=0,c=null,d=1,e;for(e in this.uploadInfo)b++;d=(b-this.waiting.length-1)/(0>=b?1:b);this.containerPanel&&this.containerPanel.parentNode&&(c=this.containerPanel.parentNode,c.scrollTop=c.scrollHeight*
d);this.get("onComplete")?this.get("onComplete")(a):this.onComplete(a);0==this.waiting.length&&(this.get("onQueueComplete")?this.get("onQueueComplete")(a.msg):this.onQueueComplete(a.msg));this.config.autoRemoveCompleted&&(a=document.getElementById(a.id),a.parentNode&&a.parentNode.removeChild(a));this.uploading=!1;this.upload()},onSelect:function(a){k("selected files: "+a.length)},onFileCountExceed:function(a,b){k("File counts:"+a+", but limited:"+b,!0)},onMaxSizeExceed:function(a){k("File:"+a.name+
" size is:"+a.size+" Exceed limited:"+a.limitSize,!0)},onExtNameMismatch:function(a){k("Allow ext name: ["+a.filters.toString()+"], not for "+a.name,!0)},onAddTask:function(a){k("Add to task \x3c\x3c name: ["+a.name)},onCancel:function(a){k("Canceled: "+a.name)},onStop:function(){k("Stopped!")},onCancelAll:function(a){k(a+" files Canceled! ")},onComplete:function(a){k("File:"+a.name+", Size:"+a.size+" onComplete\t[OK]")},onQueueComplete:function(a){k("onQueueComplete(msg: "+a+")\t---\x3d\x3d\x3e\t\t[OK]")},
onUploadError:function(a,b){k("Error Occur.  Status:"+a+", Message: "+b,!0)},disable:function(){this.fileProvider.set("enabled",!1);this.fileProvider.triggerEnabled();q(this.startPanel.children[0],"stream-disable-browser");q(this.startPanel,"disabled")},enable:function(){this.fileProvider.set("enabled",!0);this.fileProvider.triggerEnabled();r(this.startPanel.children[0],"stream-disable-browser");r(this.startPanel,"disabled")},stop:function(){if(!this.uploading)return!1;this.uploading=!1;var a=this.uploadInfo,
b;for(b in a)if(!a[b].uploadComplete){this.cancelOne(b,!0)&&this.uploadInfo[b]&&this.waiting.unshift(b);break}this.get("onStop")?this.get("onStop")():this.onStop()},destroy:function(){this.stop();this.fileProvider.destroy();this.waiting=[];if(!this.config.customered){r(this.startPanel,"stream-browse-files");r(this.startPanel,"stream-browse-drag-files-area");var a=document.getElementById(this.config.filesQueueId);for(r(a,"stream-main-upload-box");this.startPanel.firstChild;)this.startPanel.removeChild(this.startPanel.firstChild);
for(;a.firstChild;)a.removeChild(a.firstChild)}this.get("onDestroy")&&this.get("onDestroy")()},cancel:function(){this.uploading=!1;var a=this.uploadInfo,b=0,c;for(c in a)!a[c].uploadComplete&&++b&&this.cancelOne(c);this.get("onCancelAll")?this.get("onCancelAll")(b):this.onCancelAll(b)},cancelOne:function(a,b){var c=this.uploadInfo[a].file,d=this.uploadInfo[a].actived;c&&c.cancelUpload&&c.cancelUpload();if(b)return!0;var e=this.totalFileSize-this.uploadInfo[a].file.config.size,e={id:a,name:this.uploadInfo[a].file.config.name,
size:this.uploadInfo[a].file.config.size,totalSize:e,formatTotalSize:this.formatBytes(e),totalLoaded:this.totalUploadedSize,formatTotalLoaded:this.formatBytes(this.totalUploadedSize),totalPercent:0==e?0:1E4*this.totalUploadedSize/e/100};100>e.totalPercent&&(e.totalPercent=parseFloat(e.totalPercent).toFixed(2));this.get("onCancel")?this.get("onCancel")(e):this.onCancel(e);this.uploadInfo[a]&&delete this.uploadInfo[a];m(document,"click",this.cancelBtnHandler);!this.config.customered&&this.containerPanel.removeChild(document.getElementById(a));
if(d)this.uploading=!1,this.upload();else for(var f in this.waiting)this.waiting[f]===a&&this.waiting.splice(f,1);this.totalFileSize-=c.config.size;c=this.formatBytes(this.totalUploadedSize);d=1E4*this.totalUploadedSize/this.totalFileSize/100;100>d&&(d=parseFloat(d).toFixed(2));0===this.totalFileSize&&(d=100);this.config.customered||(f=this.formatBytes(this.totalFileSize),this.getNode("_stream-total-size",this.totalContainerPanel).innerHTML=f,this.getNode("_stream-total-uploaded",this.totalContainerPanel).innerHTML=
c,this.getNode("stream-percent",this.totalContainerPanel).innerHTML=d+"%",this.getNode("stream-process-bar",this.totalContainerPanel).innerHTML='\x3cspan style\x3d"width: '+d+'%;"\x3e\x3c/span\x3e')},cancelUploadHandler:function(a,b){var c=a||window.event,d=b.nodeId;this.preventDefault(c);this.stopPropagation(c);if(this.uploadInfo[d].disabled)return!1;this.uploadInfo[d]&&!this.uploadInfo[d].uploadComplete;this.cancelOne(d)},unloadHandler:function(a){a=a||window.event;if(0<this.waiting.length)return a.returnValue=
"\u60a8\u6b63\u5728\u4e0a\u4f20\u6587\u4ef6\uff0c\u5173\u95ed\u6b64\u9875\u9762\u5c06\u4f1a\u4e2d\u65ad\u4e0a\u4f20\uff0c\u5efa\u8bae\u60a8\u7b49\u5f85\u4e0a\u4f20\u5b8c\u6210\u540e\u518d\u5173\u95ed\u6b64\u9875\u9762"},upload:function(a){if(!this.uploading&&(a=this.waiting.shift(),null!=a)){this.uploading=!0;this.uploadInfo[a].actived=!0;var b=this.uploadInfo[a].file,c=this,d=this.get("frmUploadURL"),e=this.get("uploadURL"),f=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),
g={name:b.get("name"),type:b.get("type"),size:b.get("size"),modified:b.get("dateModified")+""},g=E(g,this.get("postVarsPerFile")),g=y(g,this.get("tokenURL"))+"\x26"+(new Date).getTime().toString().substring(8);f.open("GET",g,!0);f.onreadystatechange=function(){if(4!=f.readyState||200>f.status)return!1;var g,h;try{try{g=eval("("+f.responseText+")").token,h=eval("("+f.responseText+")").server}catch(l){}if(g)null!=h&&""!=h&&(d=h+d,e=h+e),v&&J?(c.uploadInfo[a].serverAddress=h,c.uploadFile(b,e,g,"resumeUpload")):
c.uploadFile(b,d,g,"formUpload");else{c.cancelOne(a);var m="\u521b\u5efa\u4e0a\u4f20\u4efb\u52a1\u5931\u8d25[tokenURL\x3d"+c.get("tokenURL")+"],\u72b6\u6001\u7801:"+f.status;k(m,!0)}}catch(n){}};window.XMLHttpRequest&&(f.onerror=function(){c.cancelOne(a);k("\u521b\u5efa\u4e0a\u4f20\u4efb\u52a1\u5931\u8d25,\u72b6\u6001\u7801:"+f.status+",\u8bf7\u68c0\u6d4b\u7f51\u7edc...",!0)});f.send()}},uploadFile:function(a,b,c,d){c={token:c,client:"formUpload"==d?"form":"html5"};b=b||"";d&&a instanceof n&&a.set("uploadMethod",
d);this.fileProvider.upload(a,b,c)},uploadProgress:function(a){var b=a.target.get("id"),c=Math.min(99.99,a.percentLoaded),d=1E4*(this.totalUploadedSize+a.bytesLoaded)/this.totalFileSize/100,d=Math.min(99.99,d);100>d&&(d=parseFloat(d).toFixed(2));if(!this.uploadInfo[b])return!1;if(this.config.customered)return a={id:b,loaded:a.bytesLoaded,formatLoaded:this.formatBytes(a.bytesLoaded),speed:a.bytesSpeed,formatSpeed:this.formatSpeed(a.bytesSpeed),size:a.bytesTotal,formatSize:this.formatBytes(a.bytesTotal),
percent:c,timeLeft:a.remainTime,formatTimeLeft:this.formatTime(a.remainTime),totalSize:this.totalFileSize,formatTotalSize:this.formatBytes(this.totalFileSize),totalLoaded:this.totalUploadedSize+a.bytesLoaded,formatTotalLoaded:this.formatBytes(this.totalUploadedSize+a.bytesLoaded),totalPercent:d},this.get("onUploadProgress")&&this.get("onUploadProgress")(a),!1;var c=this.uploadInfo[b].progressNode,d=this.uploadInfo[b].cellInfosNode,b=a.bytesLoaded,e=this.formatSpeed(a.bytesSpeed),f=this.formatBytes(b),
g=this.formatBytes(a.bytesTotal),h=this.formatTime(a.remainTime);a=Math.min(99.99,a.percentLoaded);100>a&&(a=parseFloat(a).toFixed(2));this.getNode("stream-process-bar",c).innerHTML="\x3cspan style\x3d'width:"+a+"%;'\x3e\x3c/span\x3e";this.getNode("stream-percent",c).innerHTML=a+"%";this.getNode("stream-speed",d).innerHTML=e;h&&(this.getNode("stream-remain-time",d).innerHTML=h);this.getNode("stream-uploaded",d).innerHTML=f+"/"+g;a=this.formatBytes(this.totalUploadedSize+b);c=1E4*(this.totalUploadedSize+
b)/this.totalFileSize/100;c=Math.min(99.99,c);100>c&&(c=parseFloat(c).toFixed(2));this.getNode("_stream-total-uploaded",this.totalContainerPanel).innerHTML=a;this.getNode("stream-percent",this.totalContainerPanel).innerHTML=c+"%";this.getNode("stream-process-bar",this.totalContainerPanel).innerHTML='\x3cspan style\x3d"width: '+c+'%;"\x3e\x3c/span\x3e'},uploadComplete:function(a){this.totalUploadedSize+=a.target.get("size");var b=a.target.get("id"),c=Math.min(100,a.percentLoaded),d=1E4*this.totalUploadedSize/
this.totalFileSize/100;100>d&&(d=parseFloat(d).toFixed(2));if(!this.uploadInfo[b])return!1;d={id:b,name:a.target.get("name"),loaded:a.target.get("size"),formatLoaded:this.formatBytes(a.target.get("size")),size:a.target.get("size"),formatSize:this.formatBytes(a.target.get("size")),percent:100,totalSize:this.totalFileSize,formatTotalSize:this.formatBytes(this.totalFileSize),totalLoaded:this.totalUploadedSize,formatTotalLoaded:this.formatBytes(this.totalUploadedSize),totalPercent:d,msg:a.data};this.uploadInfo[b].uploadComplete=
!0;if(!this.config.customered){var c=this.uploadInfo[b].progressNode,b=this.uploadInfo[b].cellInfosNode,e=a.target.get("size");eval("("+a.data+")");a=this.formatBytes(e);this.getNode("stream-process-bar",c).innerHTML="\x3cspan style\x3d'width:100%;'\x3e\x3c/span\x3e";this.getNode("stream-percent",c).innerHTML="100%";this.getNode("stream-uploaded",b).innerHTML=a+"/"+a;this.getNode("stream-remain-time",b).innerHTML="00:00:00";this.getNode("stream-cancel",c).innerHTML="";a=this.formatBytes(this.totalUploadedSize);
c=1E4*this.totalUploadedSize/this.totalFileSize/100;100>c&&(c=parseFloat(c).toFixed(2));0===this.totalFileSize&&(c=100);this.getNode("_stream-total-uploaded",this.totalContainerPanel).innerHTML=a;this.getNode("stream-percent",this.totalContainerPanel).innerHTML=c+"%";this.getNode("stream-process-bar",this.totalContainerPanel).innerHTML='\x3cspan style\x3d"width: '+c+'%;"\x3e\x3c/span\x3e'}this.completeUpload(d)},getNode:function(a,b){var c;var d=b||this.containerPanel;if(d)if(d.querySelectorAll)c=
d.querySelectorAll("."+a);else{c=[];for(var d=d.getElementsByTagName("*"),e=d.length,f=0;f<e;f++)RegExp("(^| )"+a+"( |$)").test(d[f].className)&&c.push(d[f])}else c=[];return c[0]||null},uploadError:function(a){this.get("onUploadError")?this.get("onUploadError")(a.status,a.statusText):this.onUploadError(a.status,a.statusText)},fileSelect:function(a){a=a.fileList;var b=0,c,d=[];for(c=0;c<a.length;c++)d.push(a[c].config);this.get("onSelect")?this.get("onSelect")(d):this.onSelect(d);for(c in this.uploadInfo)b++;
if(b==this.get("simLimit")||a.length>this.get("simLimit"))return this.get("onFileCountExceed")?this.get("onFileCountExceed")(Math.max(a.length,b),this.get("simLimit")):this.onFileCountExceed(Math.max(a.length,b),this.get("simLimit")),!1;for(c=0;c<a.length;c++)this.validateFile(a[c])&&this.addStreamTask(a[c])},validateFile:function(a){var b=a.get("name"),c=a.get("size"),b=-1!==b.indexOf(".")?b.replace(/.*[.]/,"").toLowerCase():"",d=this.get("fileFilters"),e=!1,f={id:a.get("id"),name:a.get("name"),
size:a.get("size"),formatSize:this.formatBytes(a.get("size")),lastModifiedDate:a.get("lastModifiedDate"),limitSize:this.get("maxSize"),formatLimitSize:this.formatBytes(this.get("maxSize")),filters:d};if(!v&&2147483648<c)return this.uploadError({status:100,statusText:"Flash\u6700\u5927\u53ea\u80fd\u4e0a\u4f202G\u7684\u6587\u4ef6!"}),!1;if(this.get("maxSize")<c)this.get("onMaxSizeExceed")?this.get("onMaxSizeExceed")(f):this.onMaxSizeExceed(f);else{d.length||(e=!0);for(c=0;c<d.length;c++)d[c].toLowerCase()==
"."+b&&(e=!0);e||(this.get("onExtNameMismatch")?this.get("onExtNameMismatch")(f):this.onExtNameMismatch(f))}e&&this.config.customered&&this.get("onAddTask")&&this.get("onAddTask")(f,a);return e},formatSpeed:function(a){var b=0;1024<=Math.round(a/1024)?(b=Math.round(100*(a/1048576))/100,b=Math.max(0,b),b=isNaN(b)?0:parseFloat(b).toFixed(2),a=b+"MB/s"):(b=Math.round(100*(a/1024))/100,b=Math.max(0,b),b=isNaN(b)?0:parseFloat(b).toFixed(2),a=b+"KB/s");return a},formatBytes:function(a){if(100>a)return a+
"B";if(102400>a)return a=Math.round(100*(a/1024))/100,a=isNaN(a)?0:parseFloat(a).toFixed(2),a+"K";if(1047527424>a)return a=Math.round(100*(a/1048576))/100,a=isNaN(a)?0:parseFloat(a).toFixed(2),a+"M";a=Math.round(100*(a/1073741824))/100;a=isNaN(a)?0:parseFloat(a).toFixed(2);return a+"G"},formatTime:function(a){var b=a||0;a=Math.floor(b/3600);var c=Math.floor((b-3600*a)/60),b=Math.floor(b-3600*a-60*c);a=""+(!isNaN(a)&&0<a?10>a?"0"+a+":":a+":":"00:");a+=!isNaN(c)&&0<c?10>c?"0"+c+":":c+":":"00:";return a+
(!isNaN(b)&&0<b?10>b?"0"+b+"":b:"00")},preventDefault:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},stopPropagation:function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}};var U="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",V="application/x-shockwave-flash",R="10.0.22",S="http://fpdownload.macromedia.com/pub/flashplayer/update/current/swf/autoUpdater.swf?"+Math.random(),T="SWF.eventHandler",W={align:"",allowFullScreen:"",allowNetworking:"",allowScriptAccess:"",base:"",
bgcolor:"",loop:"",menu:"",name:"",play:"",quality:"",salign:"",scale:"",tabindex:"",wmode:""},t=function(a){var b=function(a){var b=0;return parseFloat(a.replace(/\./g,function(){return 1==b++?"":"."}))},c=window,d=c&&c.navigator,e={ie:0,opera:0,gecko:0,webkit:0,safari:0,chrome:0,firefox:0,mobile:null,air:0,phantomjs:0,air:0,ipad:0,iphone:0,ipod:0,ios:null,android:0,silk:0,accel:!1,webos:0,caja:d&&d.cajaVersion,secure:!1,os:null,nodejs:0};a=a||d&&d.userAgent;var d=(c=c&&c.location)&&c.href,c=0,f,
g,h;e.userAgent=a;e.secure=d&&0===d.toLowerCase().indexOf("https");if(a){/windows|win32/i.test(a)?e.os="windows":/macintosh|mac_powerpc/i.test(a)?e.os="macintosh":/android/i.test(a)?e.os="android":/symbos/i.test(a)?e.os="symbos":/linux/i.test(a)?e.os="linux":/rhino/i.test(a)&&(e.os="rhino");/KHTML/.test(a)&&(e.webkit=1);/IEMobile|XBLWP7/.test(a)&&(e.mobile="windows");/Fennec/.test(a)&&(e.mobile="gecko");if((d=a.match(/AppleWebKit\/([^\s]*)/))&&d[1]){e.webkit=b(d[1]);(d=a.match(/Version\/([^\s]*)/))&&
d[1]&&(e.safari=d[1]);/PhantomJS/.test(a)&&(d=a.match(/PhantomJS\/([^\s]*)/))&&d[1]&&(e.phantomjs=b(d[1]));if(/Mobile\//.test(a)||/iPad|iPod|iPhone/.test(a)){if(e.mobile="Apple",(d=a.match(/OS ([^\s]*)/))&&d[1]&&(d=b(d[1].replace("_","."))),e.ios=d,e.os="ios",e.ipad=e.ipod=e.iphone=0,(d=a.match(/iPad|iPod|iPhone/))&&d[0])e[d[0].toLowerCase()]=e.ios}else{if(d=a.match(/NokiaN[^\/]*|webOS\/\d\.\d/))e.mobile=d[0];/webOS/.test(a)&&(e.mobile="WebOS",(d=a.match(/webOS\/([^\s]*);/))&&d[1])&&(e.webos=b(d[1]));
/ Android/.test(a)&&(/Mobile/.test(a)&&(e.mobile="Android"),(d=a.match(/Android ([^\s]*);/))&&d[1]&&(e.android=b(d[1])));/Silk/.test(a)&&((d=a.match(/Silk\/([^\s]*)\)/))&&d[1]&&(e.silk=b(d[1])),e.android||(e.android=2.34,e.os="Android"),/Accelerated=true/.test(a)&&(e.accel=!0))}if((d=a.match(/(Chrome|CrMo|CriOS)\/([^\s]*)/))&&d[1]&&d[2]){if(e.chrome=b(d[2]),e.safari=0,"CrMo"===d[1])e.mobile="chrome"}else if(d=a.match(/AdobeAIR\/([^\s]*)/))e.air=d[0]}if(!e.webkit)if(/Opera/.test(a)){if((d=a.match(/Opera[\s\/]([^\s]*)/))&&
d[1]&&(e.opera=b(d[1])),(d=a.match(/Version\/([^\s]*)/))&&d[1]&&(e.opera=b(d[1])),/Opera Mobi/.test(a)&&(e.mobile="opera",(d=a.replace("Opera Mobi","").match(/Opera ([^\s]*)/))&&d[1])&&(e.opera=b(d[1])),d=a.match(/Opera Mini[^;]*/))e.mobile=d[0]}else if((d=a.match(/MSIE\s([^;]*)/))&&d[1])e.ie=b(d[1]);else if(d=a.match(/Gecko\/([^\s]*)/)){if(e.gecko=1,(d=a.match(/rv:([^\s\)]*)/))&&d[1])e.gecko=b(d[1]);(d=a.match(/(Firefox)\/([^\s]*)/))&&d[1]&&d[2]&&(e.firefox=d[2])}}if(e.gecko||e.webkit||e.opera){if(b=
navigator.mimeTypes["application/x-shockwave-flash"])if(b=b.enabledPlugin)f=b.description.replace(/\s[rd]/g,".").replace(/[A-Za-z\s]+/g,"").split(".")}else if(e.ie){try{g=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6"),g.AllowScriptAccess="always"}catch(k){null!==g&&(c=6)}if(0===c)try{h=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),f=h.GetVariable("$version").replace(/[A-Za-z\s]+/g,"").split(",")}catch(l){}}"array"===x(f)&&(F(parseInt(f[0],10))&&(e.flashMajor=f[0]),F(parseInt(f[1],10))&&
(e.flashMinor=f[1]),F(parseInt(f[2],10))&&(e.flashRev=f[2]));return e}(),J=!1,v=function(){var a=!1,b=!1,c=window.FormData?!0:!1;"undefined"!=typeof File&&"undefined"!=typeof(new XMLHttpRequest).upload&&(a=!0);a&&(J="slice"in File.prototype||"mozSlice"in File.prototype||"webkitSlice"in File.prototype)&&(b=!0);for(var d=0;d<P.length;d++)-1!==navigator.userAgent.indexOf(P[d])&&(b=!1);c&&"windows"===t.os&&"5.1.7"===t.safari&&(c=!1);return a&&(c||b)}(),D=v&&"draggable"in document.createElement("span"),
X=D&&(window.webkitRequestFileSystem||window.requestFileSystem);O=v?I:H;window.Stream=window.Uploader=C})();